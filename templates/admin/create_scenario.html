{% extends "base.html" %}

{% block title %}{% if scenario %}Edit{% else %}Create{% endif %} Scenario - Don't Panic{% endblock %}

{% block extra_css %}
<style>
    .form-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px 0;
    }

    .page-header {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid var(--border-color);
    }

    .page-header h1 {
        font-size: 2rem;
        color: var(--text-primary);
        margin: 0;
    }

    .form-content {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 24px;
    }

    @media (max-width: 1024px) {
        .form-content {
            grid-template-columns: 1fr;
        }
    }

    .form-card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 24px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        color: var(--text-primary);
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 0.95rem;
    }

    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 12px;
        background: var(--bg-hover);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-sm);
        color: var(--text-primary);
        font-family: inherit;
        font-size: 0.95rem;
        transition: all 0.2s ease;
        box-sizing: border-box;
    }

    .form-group input[type="text"]:focus,
    .form-group input[type="number"]:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        border-color: var(--primary-color);
        outline: none;
        box-shadow: 0 0 10px rgba(0, 212, 255, 0.2);
    }

    .form-group textarea {
        resize: vertical;
        min-height: 100px;
    }

    .form-group select {
        appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2300d4ff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 20px;
        padding-right: 35px;
    }

    .form-hint {
        color: var(--text-secondary);
        font-size: 0.85rem;
        margin-top: 6px;
    }

    .json-editor {
        background: var(--bg-hover);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-sm);
        padding: 16px;
        margin-top: 12px;
    }

    .json-editor-label {
        color: var(--primary-color);
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 8px;
        display: block;
    }

    .json-editor textarea {
        font-family: 'Roboto Mono', monospace;
        font-size: 0.85rem;
        line-height: 1.5;
        margin-bottom: 8px;
    }

    .json-buttons {
        display: flex;
        gap: 8px;
    }

    .btn-small {
        padding: 8px 12px;
        border: 1px solid var(--primary-color);
        border-radius: var(--border-radius-sm);
        background: transparent;
        color: var(--primary-color);
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .btn-small:hover {
        background: var(--primary-color);
        color: var(--bg-primary);
    }

    .btn-small.warning {
        border-color: var(--danger-color);
        color: var(--danger-color);
    }

    .btn-small.warning:hover {
        background: var(--danger-color);
        color: white;
    }

    .sidebar-section {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 20px;
    }

    .sidebar-section h3 {
        color: var(--primary-color);
        font-size: 0.95rem;
        margin: 0 0 12px 0;
        font-weight: 600;
    }

    .sidebar-section p {
        color: var(--text-secondary);
        font-size: 0.85rem;
        line-height: 1.6;
        margin: 0 0 12px 0;
    }

    .sidebar-section ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .sidebar-section li {
        padding: 6px 0;
        color: var(--text-secondary);
        font-size: 0.85rem;
        border-bottom: 1px solid var(--border-color);
    }

    .sidebar-section li:last-child {
        border-bottom: none;
    }

    .sidebar-section code {
        background: var(--bg-hover);
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.8rem;
        color: var(--primary-color);
        font-family: 'Roboto Mono', monospace;
    }

    .form-actions {
        display: flex;
        gap: 12px;
        margin-top: 24px;
    }

    .btn-submit {
        background: var(--primary-color);
        color: var(--bg-primary);
        padding: 12px 24px;
        border: none;
        border-radius: var(--border-radius-sm);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.95rem;
    }

    .btn-submit:hover {
        box-shadow: 0 0 20px rgba(0, 212, 255, 0.4);
        transform: translateY(-2px);
    }

    .btn-cancel {
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        padding: 12px 24px;
        border-radius: var(--border-radius-sm);
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        transition: all 0.2s ease;
    }

    .btn-cancel:hover {
        border-color: var(--text-primary);
        background: var(--bg-hover);
    }

    .alert {
        padding: 12px 16px;
        border-radius: var(--border-radius-sm);
        margin-bottom: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .alert-error {
        background: rgba(255, 51, 102, 0.1);
        border: 1px solid var(--danger-color);
        color: var(--danger-color);
    }

    .alert-success {
        background: rgba(0, 212, 255, 0.1);
        border: 1px solid var(--primary-color);
        color: var(--primary-color);
    }

    .difficulty-preview {
        display: flex;
        gap: 4px;
        margin-top: 6px;
    }

    .star {
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .star:hover {
        transform: scale(1.2);
    }
</style>
{% endblock %}

{% block content %}
<div class="form-container">
    <!-- Header -->
    <div class="page-header">
        <h1>{% if scenario %}‚úèÔ∏è Edit Scenario{% else %}‚ûï Create New Scenario{% endif %}</h1>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert {% if category == 'error' %}alert-error{% else %}alert-success{% endif %}">
                    <span>{{ message }}</span>
                    <button onclick="this.parentElement.style.display='none'" style="background: none; border: none; cursor: pointer; font-size: 1.2rem; color: inherit;">√ó</button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="form-content">
        <!-- Main Form -->
        <form method="POST" id="scenarioForm">
            <div class="form-card">
                <!-- Basic Info -->
                <div class="form-group">
                    <label for="title">Scenario Title *</label>
                    <input type="text" id="title" name="title" value="{{ scenario.title if scenario else '' }}" required placeholder="e.g., Ransomware Attack Response">
                    <div class="form-hint">A descriptive name for your scenario</div>
                </div>

                <div class="form-group">
                    <label for="description">Description *</label>
                    <textarea id="description" name="description" required placeholder="Briefly describe the scenario...">{{ scenario.description if scenario else '' }}</textarea>
                    <div class="form-hint">What will trainees be learning in this scenario?</div>
                </div>

                <!-- Metadata -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label for="incident_type">Incident Type *</label>
                        <select id="incident_type" name="incident_type" required>
                            <option value="">Select type...</option>
                            <option value="ransomware" {% if scenario and scenario.incident_type == 'ransomware' %}selected{% endif %}>Ransomware</option>
                            <option value="data_breach" {% if scenario and scenario.incident_type == 'data_breach' %}selected{% endif %}>Data Breach</option>
                            <option value="ddos" {% if scenario and scenario.incident_type == 'ddos' %}selected{% endif %}>DDoS Attack</option>
                            <option value="phishing" {% if scenario and scenario.incident_type == 'phishing' %}selected{% endif %}>Phishing</option>
                            <option value="insider_threat" {% if scenario and scenario.incident_type == 'insider_threat' %}selected{% endif %}>Insider Threat</option>
                            <option value="malware" {% if scenario and scenario.incident_type == 'malware' %}selected{% endif %}>Malware</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="difficulty">Difficulty Level *</label>
                        <select id="difficulty" name="difficulty_level" required>
                            <option value="1" {% if scenario and scenario.difficulty_level == 1 %}selected{% endif %}>1 - Beginner</option>
                            <option value="2" {% if scenario and scenario.difficulty_level == 2 %}selected{% endif %}>2 - Easy</option>
                            <option value="3" {% if scenario and scenario.difficulty_level == 3 %}selected{% endif %}>3 - Medium</option>
                            <option value="4" {% if scenario and scenario.difficulty_level == 4 %}selected{% endif %}>4 - Hard</option>
                            <option value="5" {% if scenario and scenario.difficulty_level == 5 %}selected{% endif %}>5 - Expert</option>
                        </select>
                        <div class="difficulty-preview" id="difficultyPreview">
                            {% for i in range((scenario.difficulty_level if scenario else 3)) %}‚òÖ{% endfor %}
                            {% for i in range(5 - (scenario.difficulty_level if scenario else 3)) %}‚òÜ{% endfor %}
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="estimated_time">Estimated Time (minutes) *</label>
                    <input type="number" id="estimated_time" name="estimated_time" value="{{ scenario.estimated_time if scenario else 30 }}" min="5" max="180" required>
                    <div class="form-hint">How long should this scenario take?</div>
                </div>

                <div class="form-group">
                    <label style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                        <input type="checkbox" id="auto_max_points" name="auto_max_points" checked style="width:18px; height:18px; cursor:pointer;">
                        <span>Auto-calculate maximum points</span>
                    </label>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <input type="number" id="max_points" name="max_points" value="{{ scenario.max_points if scenario else 100 }}" min="1" max="10000" disabled style="flex:1;">
                        <button type="button" id="calcMaxPointsBtn" class="btn-small" style="white-space:nowrap;">Calculate</button>
                    </div>
                    <div class="form-hint">
                        <span id="max_points_hint">‚úì Auto mode: Total points = sum of all answer points</span>
                    </div>
                </div>

                <!-- Scenario Builder (friendly UI) -->
                <div class="form-group">
                    <label>Scenario Builder</label>
                    <div style="background:var(--bg-card); border:1px solid var(--border-color); padding:12px; border-radius:6px;">
                        <div style="margin-bottom:8px;">
                            <label class="json-editor-label">üìù Intro</label>
                            <textarea id="builder_intro" placeholder="Short intro/incident description" style="width:100%; padding:8px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">{{ (scenario.scenario_content|default('{}'))|safe }}</textarea>
                        </div>

                        <div id="stageBuilder" style="margin-bottom:12px;"></div>

                        <div style="display:flex; gap:8px; margin-bottom:8px;">
                            <button type="button" class="btn-small" id="addStageBtn">+ Add Stage</button>
                            <button type="button" class="btn-small" onclick="loadTemplate()">Load Example</button>
                            <button type="button" class="btn-small" onclick="formatJSONFromBuilder()">Format JSON</button>
                        </div>

                        <label style="display:flex; align-items:center; gap:8px; margin-top:6px;">
                            <input type="checkbox" id="showRawJSON"> Show raw JSON editor (Advanced)
                        </label>

                        <div id="rawJsonArea" style="display:none; margin-top:8px;">
                            <label class="json-editor-label">Raw JSON</label>
                            <textarea id="scenario_content" name="scenario_content" required style="width:100%; min-height:200px; padding:10px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">{{ scenario.scenario_content if scenario else '{"intro": "...", "stages": []}' }}</textarea>
                            <div class="json-buttons" style="margin-top:8px;">
                                <button type="button" class="btn-small" onclick="formatJSON()">Format JSON</button>
                                <button type="button" class="btn-small" onclick="validateJSON()">Validate</button>
                                <button type="button" class="btn-small" onclick="loadTemplate()">Load Template</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-hint" style="color: var(--text-secondary); margin-top: 12px;">
                        Use the builder to add stages and options. Toggle raw JSON to edit advanced content directly.
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="submit" class="btn-submit">‚úì {% if scenario %}Update Scenario{% else %}Create Scenario{% endif %}</button>
                    <a href="{{ url_for('admin.manage_scenarios') }}" class="btn-cancel">Cancel</a>
                </div>
            </div>
        </form>

        <!-- Sidebar Help -->
        <div>
            <div class="sidebar-section" style="margin-bottom: 24px;">
                <h3>üìö JSON Format Guide</h3>
                <p>Your scenario content should follow this structure:</p>
                                <code style="display: block; padding: 12px; background: var(--bg-hover); border-radius: 4px; overflow-x: auto; margin: 12px 0; font-size: 0.75rem; line-height: 1.4;">
            {<br/>
            &nbsp;&nbsp;"intro": "Initial incident summary",<br/>
            &nbsp;&nbsp;"stages": [<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;{<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"stage": "chapter_name",<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"content": "Detailed chapter/story text",<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"question": "What do you do?",<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"options": [<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"text": "Action text",<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"points": 20,<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"next": 2  <span style="color:#9aa">// optional: index of next stage, or &quot;END&quot; to finish</span><br/>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br/>
            &nbsp;&nbsp;&nbsp;&nbsp;}<br/>
            &nbsp;&nbsp;]<br/>
            }
                                </code>
            </div>

            <div class="sidebar-section">
                <h3>‚ú® Tips</h3>
                <ul>
                    <li><strong>Intro:</strong> Brief incident summary (shows only at start)</li>
                    <li><strong>Content:</strong> Detailed chapter text that updates at each stage</li>
                    <li><strong>Question:</strong> Decision prompt for the user</li>
                    <li><strong>Points:</strong> Positive for good, negative for poor choices</li>
                    <li><strong>Range:</strong> Use -30 to +30 for point values</li>
                    <li><strong>Options:</strong> Provide 3-5 realistic choices per stage</li>
                </ul>
            </div>

            <div class="sidebar-section">
                <h3>üìã Common Incident Types</h3>
                <ul>
                    <li>Ransomware</li>
                    <li>Data Breach</li>
                    <li>DDoS Attack</li>
                    <li>Phishing</li>
                    <li>Insider Threat</li>
                    <li>Malware</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
// Update difficulty preview
document.getElementById('difficulty').addEventListener('change', function() {
    const level = parseInt(this.value);
    let stars = '';
    for (let i = 0; i < level; i++) stars += '‚òÖ';
    for (let i = level; i < 5; i++) stars += '‚òÜ';
    document.getElementById('difficultyPreview').textContent = stars;
});

// Builder data model
let builder = { intro: '', stages: [] };

// Helpers to create DOM for builder
function createOptionRow(stageIndex, optionIndex, option) {
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.gap = '8px';
    row.style.marginBottom = '6px';

    const textInput = document.createElement('input');
    textInput.type = 'text';
    textInput.placeholder = 'Option text';
    textInput.value = option.text || '';
    textInput.style.flex = '1';
    textInput.addEventListener('input', () => syncFromDOM());

    const pointsInput = document.createElement('input');
    pointsInput.type = 'number';
    pointsInput.value = (option.points !== undefined) ? option.points : 0;
    pointsInput.style.width = '90px';
    pointsInput.addEventListener('input', () => syncFromDOM());

    // Next-stage selector: optional branching target
    const nextSelect = document.createElement('select');
    nextSelect.style.width = '160px';
    nextSelect.addEventListener('change', () => syncFromDOM());
    populateNextOptions(nextSelect, stageIndex);
    // if option already has next defined, set it
    if (option && option.next !== undefined && option.next !== null && option.next !== '') {
        if (option.next === 'END') nextSelect.value = 'END';
        else nextSelect.value = String(option.next);
    }

    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn-small warning';
    removeBtn.textContent = 'Remove';
    removeBtn.addEventListener('click', () => { removeOption(stageIndex, optionIndex); });

    row.appendChild(textInput);
    row.appendChild(pointsInput);
    row.appendChild(nextSelect);
    row.appendChild(removeBtn);
    return row;
}

// Populate a "next" select with available stage targets plus default/end
function populateNextOptions(selectEl, currentStageIndex) {
    // preserve previous selection if any
    const prev = selectEl.value;
    selectEl.innerHTML = '';
    const defaultOpt = document.createElement('option');
    defaultOpt.value = '';
    defaultOpt.textContent = 'Next (default)';
    selectEl.appendChild(defaultOpt);

    const endOpt = document.createElement('option');
    endOpt.value = 'END';
    endOpt.textContent = 'End Scenario';
    selectEl.appendChild(endOpt);

    // list stages by index and name
    builder.stages.forEach((st, idx) => {
        const opt = document.createElement('option');
        opt.value = idx;
        opt.textContent = `Go to ${idx + 1}: ${st.stage || '(no name)'}`;
        selectEl.appendChild(opt);
    });

    // try restore previous value
    if (prev !== undefined && prev !== null && prev !== '') {
        // if numeric string, ensure option exists
        const restore = String(prev);
        const exists = Array.from(selectEl.options).some(o => String(o.value) === restore);
        if (exists) selectEl.value = restore;
    }
}

function renderStage(stage, index) {
    const container = document.createElement('div');
    container.style.border = '1px solid var(--border-color)';
    container.style.padding = '10px';
    container.style.borderRadius = '6px';
    container.style.marginBottom = '10px';

    const header = document.createElement('div');
    header.style.display = 'flex';
    header.style.justifyContent = 'space-between';
    header.style.alignItems = 'center';
    header.style.marginBottom = '8px';

    const title = document.createElement('strong');
    title.textContent = `Stage ${index + 1}`;

    const removeStageBtn = document.createElement('button');
    removeStageBtn.type = 'button';
    removeStageBtn.className = 'btn-small warning';
    removeStageBtn.textContent = 'Remove Stage';
    removeStageBtn.addEventListener('click', () => removeStage(index));

    header.appendChild(title);
    header.appendChild(removeStageBtn);

    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.placeholder = 'Stage name (optional)';
    nameInput.value = stage.stage || '';
    nameInput.style.width = '100%';
    nameInput.style.marginBottom = '6px';
    nameInput.addEventListener('input', () => syncFromDOM());

    const contentInput = document.createElement('textarea');
    contentInput.placeholder = 'Chapter content / story text for this stage';
    contentInput.value = stage.content || '';
    contentInput.style.width = '100%';
    contentInput.style.marginBottom = '6px';
    contentInput.style.minHeight = '80px';
    contentInput.addEventListener('input', () => syncFromDOM());

    const questionInput = document.createElement('textarea');
    questionInput.placeholder = 'Question / prompt for this stage';
    questionInput.value = stage.question || '';
    questionInput.style.width = '100%';
    questionInput.style.marginBottom = '6px';
    questionInput.addEventListener('input', () => syncFromDOM());

    const optionsLabel = document.createElement('div');
    optionsLabel.textContent = 'Options';
    optionsLabel.style.marginBottom = '6px';

    const optionsContainer = document.createElement('div');
    optionsContainer.className = 'options-container';

    (stage.options || []).forEach((opt, oi) => {
        optionsContainer.appendChild(createOptionRow(index, oi, opt));
    });

    const addOptBtn = document.createElement('button');
    addOptBtn.type = 'button';
    addOptBtn.className = 'btn-small';
    addOptBtn.textContent = '+ Add Option';
    addOptBtn.addEventListener('click', () => { addOption(index); });

    container.appendChild(header);
    container.appendChild(nameInput);
    container.appendChild(contentInput);
    container.appendChild(questionInput);
    container.appendChild(optionsLabel);
    container.appendChild(optionsContainer);
    container.appendChild(addOptBtn);

    // store references for sync
    container._nameInput = nameInput;
    container._contentInput = contentInput;
    container._questionInput = questionInput;
    container._optionsContainer = optionsContainer;

    return container;
}

function renderBuilder() {
    const builderDiv = document.getElementById('stageBuilder');
    builderDiv.innerHTML = '';
    builderDiv.appendChild(document.createElement('div'));
    builder.stages.forEach((stage, idx) => {
        const el = renderStage(stage, idx);
        builderDiv.appendChild(el);
    });
    // After render, repopulate next-selects for all option rows (in case stages changed)
    const selects = builderDiv.querySelectorAll('select');
    selects.forEach(s => populateNextOptions(s));
}

function addStage(stageObj) {
    const newStage = stageObj || { stage: '', question: '', options: [{ text: '', points: 0 }] };
    builder.stages.push(newStage);
    renderBuilder();
}

function removeStage(index) {
    builder.stages.splice(index, 1);
    renderBuilder();
}

function addOption(stageIndex, optionObj) {
    const opts = builder.stages[stageIndex].options || [];
    opts.push(optionObj || { text: '', points: 0 });
    builder.stages[stageIndex].options = opts;
    renderBuilder();
}

function removeOption(stageIndex, optionIndex) {
    const opts = builder.stages[stageIndex].options || [];
    opts.splice(optionIndex, 1);
    builder.stages[stageIndex].options = opts;
    renderBuilder();
}

// Read the DOM values into builder model
function syncFromDOM() {
    const builderDiv = document.getElementById('stageBuilder');
    const children = Array.from(builderDiv.children).filter(n => n && n._nameInput);
    const newStages = children.map((child) => {
        const stageName = child._nameInput.value;
        const content = child._contentInput.value;
        const question = child._questionInput.value;
        const opts = [];
            const optionRows = Array.from(child._optionsContainer.children);
            optionRows.forEach((row) => {
                // include select for next target in addition to inputs
                const inputs = row.querySelectorAll('input, select');
                if (inputs.length >= 2) {
                    const text = inputs[0].value;
                    const points = parseInt(inputs[1].value) || 0;
                    let next = null;
                    if (inputs.length >= 3) {
                        const sel = inputs[2];
                        // treat empty string as null, 'END' as special end marker, numeric strings as indices
                        if (sel && sel.value !== '') {
                            if (sel.value === 'END') next = 'END';
                            else if (!isNaN(parseInt(sel.value))) next = parseInt(sel.value);
                            else next = sel.value;
                        }
                    }
                    const optObj = { text: text, points: points };
                    if (next !== null) optObj.next = next;
                    opts.push(optObj);
                }
            });
        const stageObj = { stage: stageName, content: content, question: question, options: opts };
        return stageObj;
    });
    builder.stages = newStages;
    // update intro
    const introEl = document.getElementById('builder_intro');
    builder.intro = introEl ? introEl.value : '';
}

function updateTextareaFromBuilder() {
    syncFromDOM();
    const textarea = document.getElementById('scenario_content');
    if (!textarea) return;
    const out = { intro: builder.intro || '', stages: builder.stages || [] };
    textarea.value = JSON.stringify(out, null, 2);
}

function formatJSONFromBuilder() {
    updateTextareaFromBuilder();
    formatJSON();
}

// Existing helpers operate on #scenario_content textarea
function formatJSON() {
    const textarea = document.getElementById('scenario_content');
    try {
        const parsed = JSON.parse(textarea.value);
        textarea.value = JSON.stringify(parsed, null, 2);
        alert('‚úÖ JSON formatted');
    } catch (e) {
        alert('‚ùå Invalid JSON: ' + e.message);
    }
}

function validateJSON() {
    const textarea = document.getElementById('scenario_content');
    try {
        const parsed = JSON.parse(textarea.value);
        if (!parsed.intro || !parsed.stages) {
            alert('‚ùå Missing required fields: "intro" and/or "stages"');
            return;
        }
        if (!Array.isArray(parsed.stages)) {
            alert('‚ùå "stages" must be an array');
            return;
        }
        alert('‚úÖ JSON is valid!');
    } catch (e) {
        alert('‚ùå Invalid JSON: ' + e.message);
    }
}

function loadTemplate() {
    const template = {
        "intro": "Your company's systems have been compromised. You are the incident response lead.",
        "stages": [
            {
                "stage": "detection",
                "content": "The Security Operations Center (SOC) team has detected suspicious login attempts from an unfamiliar IP address. Your monitoring systems show unusual outbound traffic to known malicious domains. The incident timeline shows the attack began 2 hours ago.",
                "question": "What is your first action?",
                "options": [
                    {"text": "Escalate to Security Team immediately", "points": 25},
                    {"text": "Investigate on your own first", "points": 15},
                    {"text": "Ignore it and continue work", "points": -30}
                ]
            },
            {
                "stage": "containment",
                "content": "Your team confirms the attacker has gained access to sensitive data servers. They are actively exfiltrating customer information. Network logs show 500 GB of data transfer to the external IP address over the past 30 minutes.",
                "question": "How do you contain the threat?",
                "options": [
                    {"text": "Isolate affected systems from network", "points": 30},
                    {"text": "Shut down all systems", "points": 10},
                    {"text": "Just monitor the situation", "points": -20}
                ]
            }
        ]
    };
    // populate builder
    builder = template;
    document.getElementById('builder_intro').value = builder.intro;
    renderBuilder();
    updateTextareaFromBuilder();
    alert('‚úÖ Template loaded into builder');
}

// Toggle raw JSON view
document.getElementById('showRawJSON').addEventListener('change', function() {
    const area = document.getElementById('rawJsonArea');
    if (this.checked) {
        updateTextareaFromBuilder();
        area.style.display = 'block';
    } else {
        area.style.display = 'none';
    }
});

// Quick add stage button
document.getElementById('addStageBtn').addEventListener('click', function() { addStage(); });

// Initialize on load: try to parse existing scenario JSON and populate builder
document.addEventListener('DOMContentLoaded', function() {
    // initialize builder intro default if scenario exists
    try {
        const raw = {{ scenario.scenario_content|default('{}')|tojson }};
        let parsed = {};
        if (raw) {
            parsed = JSON.parse(raw);
        }
        if (parsed && (parsed.stages || parsed.intro)) {
            builder.intro = parsed.intro || '';
            builder.stages = parsed.stages || [];
        } else {
            // if no parsed content, keep builder empty
            builder = { intro: '', stages: [] };
        }
    } catch (e) {
        builder = { intro: '', stages: [] };
    }

    // set intro textarea and render
    const introEl = document.getElementById('builder_intro');
    if (introEl) introEl.value = builder.intro || '';
    renderBuilder();

    // wireup: whenever the builder loses focus, sync
    document.getElementById('stageBuilder').addEventListener('input', () => updateTextareaFromBuilder());
    const introElem = document.getElementById('builder_intro');
    if (introElem) introElem.addEventListener('input', () => updateTextareaFromBuilder());

    // If raw JSON exists (editing scenario), ensure raw area hidden by default but up-to-date
    const rawArea = document.getElementById('rawJsonArea');
    if (rawArea) rawArea.style.display = 'none';
    updateTextareaFromBuilder();

    // Form submission: ensure textarea has builder JSON if raw not shown
    document.getElementById('scenarioForm').addEventListener('submit', function(e) {
        const rawShown = document.getElementById('showRawJSON').checked;
        if (!rawShown) {
            updateTextareaFromBuilder();
        }
        // validate JSON
        try {
            JSON.parse(document.getElementById('scenario_content').value);
        } catch (err) {
            e.preventDefault();
            alert('‚ùå Invalid JSON in scenario content: ' + err.message);
        }
    });

    // Auto max points functionality
    const autoCheckbox = document.getElementById('auto_max_points');
    const maxPointsInput = document.getElementById('max_points');
    const calcBtn = document.getElementById('calcMaxPointsBtn');
    const hint = document.getElementById('max_points_hint');

    // Toggle input enabled/disabled based on checkbox
    autoCheckbox.addEventListener('change', function() {
        maxPointsInput.disabled = this.checked;
        if (this.checked) {
            hint.textContent = '‚úì Auto mode: Total points = sum of all answer points';
            calculateMaxPointsFromScenario();
        } else {
            hint.textContent = '‚úé Manual mode: Set points yourself';
        }
    });

    // Manual calculate button
    calcBtn.addEventListener('click', function() {
        calculateMaxPointsFromScenario();
    });

    // Function to calculate max points from scenario
    function calculateMaxPointsFromScenario() {
        try {
            // Get current scenario from textarea
            const contentText = document.getElementById('scenario_content').value;
            const scenario = JSON.parse(contentText);
            
            if (!scenario.stages || scenario.stages.length === 0) {
                maxPointsInput.value = 100;
                return;
            }

            // Sum all points from all options in all stages
            let totalPoints = 0;
            scenario.stages.forEach(stage => {
                // Get the HIGHEST points from each stage (best answer path)
                if (stage.options && stage.options.length > 0) {
                    let maxStagePoints = 0;
                    stage.options.forEach(option => {
                        const points = parseInt(option.points) || 0;
                        if (points > maxStagePoints) {
                            maxStagePoints = points;
                        }
                    });
                    totalPoints += maxStagePoints;
                }
            });

            // Set calculated value to actual sum, or 100 if no points
            const calculatedPoints = totalPoints > 0 ? totalPoints : 100;
            maxPointsInput.value = calculatedPoints;
            
            if (autoCheckbox.checked) {
                hint.textContent = `‚úì Auto calculated: ${calculatedPoints} points (sum of best answers per stage)`;
            }
        } catch (err) {
            console.error('Error calculating max points:', err);
            alert('Could not calculate max points. Please ensure scenario JSON is valid.');
        }
    }

    // Auto-calculate when builder updates
    const originalUpdateTextarea = updateTextareaFromBuilder;
    updateTextareaFromBuilder = function() {
        originalUpdateTextarea.call(this);
        if (autoCheckbox.checked) {
            calculateMaxPointsFromScenario();
        }
    };
});
</script>
{% endblock %}
