{% extends "base.html" %}

{% block title %}Manage Scenarios - Don't Panic{% endblock %}

{% block extra_css %}
<style>
    .manage-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px 0;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid var(--border-color);
    }

    .page-header h1 {
        font-size: 2rem;
        color: var(--text-primary);
        margin: 0;
    }

    .btn-primary-custom {
        background: var(--primary-color);
        color: var(--bg-primary);
        padding: 12px 24px;
        border: none;
        border-radius: var(--border-radius-sm);
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        transition: all 0.2s ease;
    }

    .btn-primary-custom:hover {
        box-shadow: 0 0 20px rgba(0, 212, 255, 0.4);
        transform: translateY(-2px);
    }

    .scenarios-grid {
        display: grid;
        gap: 20px;
    }

    .scenario-item {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 20px;
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 20px;
        align-items: start;
        transition: all 0.2s ease;
    }

    .scenario-item:hover {
        border-color: var(--primary-color);
        box-shadow: 0 0 15px rgba(0, 212, 255, 0.15);
    }

    .scenario-info h3 {
        margin: 0 0 8px 0;
        color: var(--text-primary);
        font-size: 1.3rem;
    }

    .scenario-info p {
        color: var(--text-secondary);
        margin: 8px 0;
        line-height: 1.5;
    }

    .scenario-meta {
        display: flex;
        gap: 20px;
        margin-top: 12px;
        flex-wrap: wrap;
    }

    .meta-badge {
        background: var(--bg-hover);
        padding: 6px 12px;
        border-radius: var(--border-radius-sm);
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    .meta-badge strong {
        color: var(--primary-color);
    }

    .difficulty-stars {
        color: var(--primary-color);
        font-size: 1.1rem;
        letter-spacing: 2px;
    }

    .scenario-actions {
        display: flex;
        gap: 10px;
        flex-direction: column;
    }

    .btn-icon {
        padding: 10px 16px;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-sm);
        background: var(--bg-hover);
        color: var(--text-primary);
        cursor: pointer;
        text-decoration: none;
        font-size: 0.9rem;
        transition: all 0.2s ease;
        font-weight: 500;
    }

    .btn-icon:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
        transform: translateX(2px);
    }

    .btn-danger {
        border-color: var(--danger-color);
        color: var(--danger-color);
    }

    .btn-danger:hover {
        background: var(--danger-color);
        color: white;
    }

    .btn-edit {
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
    }

    .empty-state h2 {
        color: var(--text-primary);
        margin-bottom: 12px;
    }

    .empty-state p {
        margin-bottom: 24px;
    }

    @media (max-width: 768px) {
        .page-header {
            flex-direction: column;
            gap: 16px;
            align-items: flex-start;
        }

        .scenario-item {
            grid-template-columns: 1fr;
        }

        .scenario-actions {
            flex-direction: row;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="manage-container">
    <!-- Header -->
    <div class="page-header">
        <div>
            <h1>üìö Manage Scenarios</h1>
        </div>
        <div style="display:flex; gap:12px; align-items:center;">
            <a href="{{ url_for('admin.create_scenario') }}" class="btn-primary-custom">+ Create New Scenario</a>
        </div>
    </div>

    <!-- Quick Create (collapsible) -->
    <div style="margin-bottom: 18px;">
        <details>
            <summary style="cursor:pointer; padding:12px 16px; background:var(--bg-card); border:1px solid var(--border-color); border-radius: var(--border-radius-sm);">Quick Create Scenario</summary>
            <div style="padding:16px; background:var(--bg-card); border:1px solid var(--border-color); border-top:none;">
                <form id="quickCreateForm" method="POST" action="{{ url_for('admin.create_scenario') }}">
                    <input type="hidden" name="scenario_content" id="scenario_content_hidden" value='{"intro":"","stages":[]}'>

                    <div style="display:grid; gap:8px; grid-template-columns: 1fr 200px; margin-bottom:8px;">
                        <input type="text" id="qc_title" name="title" placeholder="Title" required style="padding:10px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                        <select id="qc_incident_type" name="incident_type" style="padding:10px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                            <option value="ransomware">Ransomware</option>
                            <option value="data_breach">Data Breach</option>
                            <option value="ddos">DDoS</option>
                            <option value="phishing">Phishing</option>
                            <option value="insider_threat">Insider Threat</option>
                            <option value="malware">Malware</option>
                        </select>
                    </div>

                    <div style="margin-bottom:8px;">
                        <textarea id="qc_description" name="description" placeholder="Short description" required style="width:100%; padding:10px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary); min-height:60px;"></textarea>
                    </div>

                    <div style="display:flex; gap:8px; margin-bottom:8px;">
                        <select id="qc_difficulty" name="difficulty_level" style="padding:10px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                            <option value="1">1 - Beginner</option>
                            <option value="2">2 - Easy</option>
                            <option value="3" selected>3 - Medium</option>
                            <option value="4">4 - Hard</option>
                            <option value="5">5 - Expert</option>
                        </select>
                        <input type="number" id="qc_time" name="estimated_time" value="30" min="5" max="180" style="padding:10px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);">
                        <label style="display:flex; align-items:center; gap:6px; color:var(--text-secondary);">
                            <input type="checkbox" id="advancedToggle"> Advanced (JSON)
                        </label>
                    </div>

                    <div id="advancedArea" style="display:none; margin-bottom:8px;">
                        <textarea id="scenario_content_visible" placeholder='{"intro":"...","stages":[]}' style="width:100%; height:140px; padding:10px; background:var(--bg-hover); border:1px solid var(--border-color); border-radius:6px; color:var(--text-primary);"></textarea>
                    </div>

                    <div style="display:flex; gap:8px;">
                        <button type="submit" class="btn-primary-custom">Create</button>
                        <a href="{{ url_for('admin.create_scenario') }}" class="btn-icon" style="align-self:center; padding:8px 12px;">Open Editor</a>
                    </div>
                </form>
            </div>
        </details>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert {% if category == 'success' %}alert-success{% else %}alert-error{% endif %}">
                    <span>{{ message }}</span>
                    <button class="close-btn" onclick="this.parentElement.style.display='none'">√ó</button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Scenarios List -->
    {% if scenarios %}
        <div class="scenarios-grid">
            {% for scenario in scenarios %}
                <div class="scenario-item">
                    <div class="scenario-info">
                        <h3>{{ scenario.title }}</h3>
                        <p>{{ scenario.description }}</p>
                        
                        <div class="scenario-meta">
                            <div class="meta-badge">
                                <strong>Type:</strong> {{ scenario.incident_type|capitalize }}
                            </div>
                            <div class="meta-badge">
                                <strong>Difficulty:</strong> 
                                <span class="difficulty-stars">
                                    {% for i in range(scenario.difficulty_level) %}‚òÖ{% endfor %}
                                    {% for i in range(5 - scenario.difficulty_level) %}‚òÜ{% endfor %}
                                </span>
                            </div>
                            <div class="meta-badge">
                                <strong>Time:</strong> {{ scenario.estimated_time }} min
                            </div>
                            <div class="meta-badge">
                                <strong>Played:</strong> {{ scenario.times_played }} times
                            </div>
                            <div class="meta-badge">
                                <strong>Avg Score:</strong> {{ "%.1f"|format(scenario.average_score) }}%
                            </div>
                        </div>
                    </div>

                    <div class="scenario-actions">
                        <a href="{{ url_for('admin.edit_scenario', scenario_id=scenario.id) }}" class="btn-icon btn-edit">‚úèÔ∏è Edit</a>
                        <form method="POST" action="{{ url_for('admin.delete_scenario', scenario_id=scenario.id) }}" onsubmit="return confirm('Are you sure you want to delete this scenario? This cannot be undone.');" style="display:inline;">
                            <button type="submit" class="btn-icon btn-danger">üóëÔ∏è Delete</button>
                        </form>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <h2>No scenarios yet</h2>
            <p>Create your first scenario to get started</p>
            <a href="{{ url_for('admin.create_scenario') }}" class="btn-primary-custom">+ Create Scenario</a>
        </div>
    {% endif %}
</div>

<script>
    // Quick Create form behavior
    (function() {
        const advToggle = document.getElementById('advancedToggle');
        const advArea = document.getElementById('advancedArea');
        if (advToggle && advArea) {
            advToggle.addEventListener('change', function() {
                advArea.style.display = this.checked ? 'block' : 'none';
            });
        }

        const qcForm = document.getElementById('quickCreateForm');
        if (qcForm) {
            qcForm.addEventListener('submit', function(e) {
                // Build scenario_content if advanced not used
                const advanced = document.getElementById('advancedToggle').checked;
                const hiddenInput = document.getElementById('scenario_content_hidden');
                if (!advanced) {
                    const intro = document.getElementById('qc_description').value || '';
                    const content = { intro: intro, stages: [] };
                    hiddenInput.value = JSON.stringify(content);
                } else {
                    const visible = document.getElementById('scenario_content_visible').value || '';
                    hiddenInput.value = visible;
                }
                // allow submit to continue
            });
        }
    })();

    // Delete handler
    function deleteScenario(scenarioId, title) {
            if (confirm(`Are you sure you want to delete "${title}"? This cannot be undone.`)) {
                fetch(`/admin/scenarios/${scenarioId}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                })
                .then(async response => {
                    // Try to parse JSON if possible, otherwise fallback to text
                    let payload = null;
                    try {
                        payload = await response.json();
                    } catch (e) {
                        const txt = await response.text();
                        throw new Error(txt || `HTTP ${response.status}`);
                    }

                    if (!response.ok) {
                        throw new Error(payload.error || payload.message || `HTTP ${response.status}`);
                    }

                    return payload;
                })
                .then(data => {
                    if (data && data.success) {
                        alert('‚úÖ Scenario deleted successfully');
                        location.reload();
                    } else {
                        alert('‚ùå Error deleting scenario: ' + (data && data.error ? data.error : 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error deleting scenario:', error);
                    alert('‚ùå Error deleting scenario: ' + (error.message || error));
                });
            }
    }
</script>
{% endblock %}
